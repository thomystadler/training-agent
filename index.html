<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="module">
    import React, { useState } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import { Activity } from 'https://esm.sh/lucide-react@0.263.1';

    const CONFIG = {
      WORKER_URL: 'https://intervals-icu-proxy.thomystadler.workers.dev',
      DEFAULT_API_KEY: '3zemjjfaoba8649t72snopm65',
      DEFAULT_ATHLETE_ID: 'i177384'
    };

    function TrainingAgent() {
      const [apiKey, setApiKey] = useState(CONFIG.DEFAULT_API_KEY);
      const [athleteId, setAthleteId] = useState(CONFIG.DEFAULT_ATHLETE_ID);
      const [isConnected, setIsConnected] = useState(false);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [athleteData, setAthleteData] = useState(null);

      const callAPI = async (endpoint) => {
        const url = `${CONFIG.WORKER_URL}/proxy${endpoint}`;
        
        console.log('ðŸ” Calling:', url);
        console.log('ðŸ”‘ API Key:', apiKey ? 'Present' : 'Missing');
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-API-Key': apiKey,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          mode: 'cors'
        });
        
        console.log('ðŸ“¡ Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Error:', errorText);
          throw new Error(`API Error ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('âœ… Data received:', data);
        
        return data;
      };

      const connectToAPI = async () => {
        setLoading(true);
        setError('');
        
        console.log('ðŸš€ Starting connection...');
        console.log('ðŸ“ API Key:', apiKey);
        console.log('ðŸ‘¤ Athlete ID:', athleteId);
        
        if (!apiKey || apiKey.trim() === '') {
          setError('API-Key fehlt! Bitte eingeben.');
          setLoading(false);
          return;
        }
        
        try {
          console.log('ðŸ“ž Calling athlete API...');
          
          // Hole Athlete Basis-Daten
          const athlete = await callAPI(`/api/v1/athlete/${athleteId}`);
          console.log('âœ… Athlete data:', athlete);
          
          // Hole Wellness/Fitness-Daten fÃ¼r heute
          const today = new Date().toISOString().split('T')[0];
          console.log('ðŸ“ž Calling wellness API for:', today);
          
          try {
            const wellness = await callAPI(`/api/v1/athlete/${athleteId}/wellness/${today}`);
            console.log('âœ… Wellness data:', wellness);
            
            // Kombiniere Daten
            setAthleteData({
              ...athlete,
              ctl: wellness?.ctl || athlete.ctl || 0,
              atl: wellness?.atl || athlete.atl || 0,
              tsb: wellness?.form || athlete.yesterday_tsb || 0,
              hrvSDNN: wellness?.hrvSDNN || 0,
              restingHR: wellness?.restingHR || athlete.icu_resting_hr || 0
            });
          } catch (wellnessError) {
            console.warn('âš ï¸ Wellness data not available, using athlete data only');
            // Falls kein Wellness fÃ¼r heute verfÃ¼gbar, nutze Athlete-Daten
            setAthleteData({
              ...athlete,
              ctl: athlete.ctl || 0,
              atl: athlete.atl || 0,
              tsb: athlete.yesterday_tsb || 0,
              restingHR: athlete.icu_resting_hr || 0
            });
          }
          
          setIsConnected(true);
        } catch (err) {
          console.error('âŒ Connection error:', err);
          setError(err.message);
          setIsConnected(false);
        } finally {
          setLoading(false);
        }
      };

      if (!isConnected) {
        return React.createElement('div', {
          className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4'
        },
          React.createElement('div', {
            className: 'bg-slate-800 rounded-xl shadow-2xl p-8 max-w-md w-full border border-slate-700'
          },
            React.createElement('div', { className: 'text-center mb-6' },
              React.createElement(Activity, { className: 'w-16 h-16 text-blue-400 mx-auto mb-4' }),
              React.createElement('h1', { className: 'text-3xl font-bold text-white mb-2' }, 'Training Agent'),
              React.createElement('p', { className: 'text-slate-400' }, 'Ultra Endurance Coach')
            ),
            React.createElement('div', { className: 'space-y-4' },
              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Athlete ID'),
                React.createElement('input', {
                  type: 'text',
                  value: athleteId,
                  onChange: (e) => setAthleteId(e.target.value),
                  className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none'
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'API Key'),
                React.createElement('input', {
                  type: 'password',
                  value: apiKey,
                  onChange: (e) => setApiKey(e.target.value),
                  className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none'
                })
              ),
              error && React.createElement('div', {
                className: 'bg-red-900/30 border border-red-700 text-red-300 px-4 py-3 rounded-lg text-sm flex items-start'
              }, error),
              React.createElement('button', {
                onClick: connectToAPI,
                disabled: loading,
                className: 'w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors disabled:opacity-50'
              }, loading ? 'Verbinde...' : 'Verbinden')
            )
          )
        );
      }

      return React.createElement('div', {
        className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-8'
      },
        React.createElement('div', { className: 'max-w-4xl mx-auto' },
          React.createElement('div', { className: 'mb-8' },
            React.createElement('h1', { className: 'text-4xl font-bold mb-2' }, 'Training Agent'),
            React.createElement('p', { className: 'text-slate-400' }, `Hallo ${athleteData.firstname || 'Athlet'}!`)
          ),
          
          React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700 mb-6' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4 flex items-center' },
              React.createElement('span', { className: 'mr-2' }, 'âœ…'),
              'Verbunden mit Intervals.icu'
            ),
            React.createElement('div', { className: 'grid grid-cols-3 gap-6' },
              React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                React.createElement('div', { className: 'text-3xl font-bold text-blue-400' }, 
                  athleteData.ctl ? athleteData.ctl.toFixed(0) : 'N/A'
                ),
                React.createElement('div', { className: 'text-sm text-slate-400 mt-1' }, 'CTL (Fitness)'),
                React.createElement('div', { className: 'text-xs text-slate-500 mt-2' }, 'Chronische Trainingsbelastung')
              ),
              React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                React.createElement('div', { className: 'text-3xl font-bold text-orange-400' }, 
                  athleteData.atl ? athleteData.atl.toFixed(0) : 'N/A'
                ),
                React.createElement('div', { className: 'text-sm text-slate-400 mt-1' }, 'ATL (ErmÃ¼dung)'),
                React.createElement('div', { className: 'text-xs text-slate-500 mt-2' }, 'Akute Trainingsbelastung')
              ),
              React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                React.createElement('div', { className: 'text-3xl font-bold text-green-400' }, 
                  athleteData.tsb ? athleteData.tsb.toFixed(0) : 'N/A'
                ),
                React.createElement('div', { className: 'text-sm text-slate-400 mt-1' }, 'TSB (Form)'),
                React.createElement('div', { className: 'text-xs text-slate-500 mt-2' }, 'Training Stress Balance')
              )
            )
          ),

          React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700' },
            React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Recovery-Daten'),
            React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
              React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                React.createElement('div', { className: 'text-2xl font-bold' }, 
                  athleteData.restingHR || 'N/A'
                ),
                React.createElement('div', { className: 'text-sm text-slate-400 mt-1' }, 'Ruhepuls (bpm)')
              ),
              React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                React.createElement('div', { className: 'text-2xl font-bold' }, 
                  athleteData.icu_weight ? `${athleteData.icu_weight} kg` : 'N/A'
                ),
                React.createElement('div', { className: 'text-sm text-slate-400 mt-1' }, 'Gewicht')
              )
            )
          ),

          React.createElement('div', { className: 'mt-6 text-center text-sm text-slate-500' },
            'NÃ¤chster Schritt: Recovery Dashboard + Chat â†’ Coming soon!'
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(
      React.createElement(TrainingAgent)
    );
  </script>
</body>
</html>
