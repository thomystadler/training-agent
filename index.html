<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training Agent - Recovery Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import { Activity, Heart, Calendar, RefreshCw, AlertCircle } from 'https://esm.sh/lucide-react@0.263.1';

    const CONFIG = {
      WORKER_URL: 'https://intervals-icu-proxy.thomystadler.workers.dev',
      DEFAULT_API_KEY: '3zemjjfaoba8649t72snopm65',
      DEFAULT_ATHLETE_ID: 'i177384'
    };

    function TrainingAgent() {
      const [apiKey, setApiKey] = useState(CONFIG.DEFAULT_API_KEY);
      const [athleteId, setAthleteId] = useState(CONFIG.DEFAULT_ATHLETE_ID);
      const [isConnected, setIsConnected] = useState(false);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const [athleteData, setAthleteData] = useState(null);
      const [wellnessData, setWellnessData] = useState([]);
      const [todayWellness, setTodayWellness] = useState(null);
      const [recentActivities, setRecentActivities] = useState([]);
      const [upcomingEvents, setUpcomingEvents] = useState([]);
      
      // Check-in State
      const [feeling, setFeeling] = useState('');
      const [notes, setNotes] = useState('');
      const [checkedIn, setCheckedIn] = useState(false);

      // Load check-in from LocalStorage
      useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        const stored = localStorage.getItem(`checkin_${today}`);
        if (stored) {
          const data = JSON.parse(stored);
          setFeeling(data.feeling);
          setNotes(data.notes);
          setCheckedIn(true);
        }
      }, []);

      // Parse Check-in aus Intervals.icu Wellness Comments
      const parseCheckinFromWellness = (wellness) => {
        if (!wellness || !wellness.comments) return null;
        
        // Format: "Befinden: frisch | Notizen hier..."
        const match = wellness.comments.match(/Befinden: (\w+)(?:\s*\|\s*(.+))?/);
        if (match) {
          return {
            feeling: match[1],
            notes: match[2] || ''
          };
        }
        return null;
      };

      const callAPI = async (endpoint, method = 'GET', body = null) => {
        const url = `${CONFIG.WORKER_URL}/proxy${endpoint}`;
        const options = {
          method,
          headers: {
            'X-API-Key': apiKey,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        };
        
        if (body && method !== 'GET') {
          options.body = JSON.stringify(body);
        }
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error ${response.status}: ${errorText}`);
        }
        
        return await response.json();
      };

      const connectToAPI = async () => {
        setLoading(true);
        setError('');
        
        try {
          // Athlete Daten
          const athlete = await callAPI(`/api/v1/athlete/${athleteId}`);
          setAthleteData(athlete);
          
          // Wellness letzte 7 Tage
          const wellnessArray = [];
          const today = new Date();
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            try {
              const dayWellness = await callAPI(`/api/v1/athlete/${athleteId}/wellness/${dateStr}`);
              if (dayWellness) {
                wellnessArray.push({ ...dayWellness, date: dateStr });
              }
            } catch (err) {
              console.warn(`No wellness for ${dateStr}`);
            }
          }
          
          setWellnessData(wellnessArray);
          if (wellnessArray.length > 0) {
            setTodayWellness(wellnessArray[0]);
            
            // Check-in aus Intervals.icu laden - NUR wenn von HEUTE
            const today = new Date().toISOString().split('T')[0];
            const wellnessDate = wellnessArray[0].date || wellnessArray[0].id;
            
            if (wellnessDate === today) {
              const todayCheckin = parseCheckinFromWellness(wellnessArray[0]);
              if (todayCheckin) {
                setFeeling(todayCheckin.feeling);
                setNotes(todayCheckin.notes);
                setCheckedIn(true);
                // Auch in LocalStorage speichern f√ºr Offline-Verf√ºgbarkeit
                localStorage.setItem(`checkin_${today}`, JSON.stringify({
                  feeling: todayCheckin.feeling,
                  notes: todayCheckin.notes,
                  timestamp: wellnessArray[0].updated || new Date().toISOString()
                }));
              }
            }
          }
          
          // Letzte Aktivit√§ten (30 Tage)
          const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          const todayStr = new Date().toISOString().split('T')[0];
          console.log('Fetching activities from', monthAgo, 'to', todayStr);
          const activities = await callAPI(`/api/v1/athlete/${athleteId}/activities?oldest=${monthAgo}&newest=${todayStr}`);
          
          if (Array.isArray(activities)) {
            console.log(`Loaded ${activities.length} activities`);
            if (activities.length > 0) {
              console.log('First activity date:', activities[0].start_date_local);
              console.log('Last activity date:', activities[activities.length - 1].start_date_local);
            }
            setRecentActivities(activities);
          }
          
          // Events (kommende)
          try {
            const events = await callAPI(`/api/v1/athlete/${athleteId}/events`);
            if (Array.isArray(events)) {
              const today = new Date().toISOString().split('T')[0];
              const upcoming = events.filter(e => e.start_date_local >= today).sort((a, b) => 
                new Date(a.start_date_local) - new Date(b.start_date_local)
              );
              setUpcomingEvents(upcoming);
              console.log(`Loaded ${upcoming.length} upcoming events`);
            }
          } catch (err) {
            console.warn('No events found');
          }
          
          setIsConnected(true);
        } catch (err) {
          console.error('Connection error:', err);
          setError(err.message);
          setIsConnected(false);
        } finally {
          setLoading(false);
        }
      };

      // Check-in speichern
      const handleCheckIn = async () => {
        const today = new Date().toISOString().split('T')[0];
        const checkinData = { feeling, notes, timestamp: new Date().toISOString() };
        
        // LocalStorage
        localStorage.setItem(`checkin_${today}`, JSON.stringify(checkinData));
        
        // Zu Intervals.icu schicken (als Wellness-Kommentar)
        try {
          const wellnessUpdate = {
            comments: `Befinden: ${feeling}${notes ? ' | ' + notes : ''}`
          };
          await callAPI(`/api/v1/athlete/${athleteId}/wellness/${today}`, 'PUT', wellnessUpdate);
        } catch (err) {
          console.warn('Wellness update failed:', err);
        }
        
        setCheckedIn(true);
        alert('Check-in gespeichert!');
      };

      // Recovery Score mit Check-in Override
      const calculateRecoveryScore = () => {
        if (!todayWellness || !wellnessData.length) return null;
        
        const recent = wellnessData.filter(d => d.hrv || d.hrvSDNN || d.restingHR);
        if (recent.length < 2) return null;
        
        const avgHRV = recent.reduce((sum, d) => sum + (d.hrv || d.hrvSDNN || 0), 0) / recent.length;
        const avgRHR = recent.reduce((sum, d) => sum + (d.restingHR || 0), 0) / recent.length;
        
        const todayHRV = todayWellness.hrv || todayWellness.hrvSDNN || 0;
        const todayRHR = todayWellness.restingHR || 0;
        
        const hrvDelta = avgHRV > 0 ? ((todayHRV - avgHRV) / avgHRV * 100) : 0;
        const rhrDelta = avgRHR > 0 ? ((todayRHR - avgRHR) / avgRHR * 100) : 0;
        
        let score = 7;
        
        // HRV (70%)
        if (hrvDelta > 5) score += 2;
        else if (hrvDelta > 0) score += 1;
        else if (hrvDelta > -5) score -= 0.5;
        else if (hrvDelta > -10) score -= 1.5;
        else score -= 2.5;
        
        // Ruhepuls (20%)
        if (rhrDelta < -5) score += 0.5;
        else if (rhrDelta > 10) score -= 1.5;
        else if (rhrDelta > 5) score -= 0.5;
        
        // ATL (10%)
        const atl = todayWellness.atl || 0;
        if (atl > 150) score -= 1;
        else if (atl > 120) score -= 0.5;
        
        // Subjektives Befinden Override
        if (feeling === 'erschoepft') score = Math.min(score, 5);
        else if (feeling === 'muede') score -= 1;
        else if (feeling === 'frisch') score += 0.5;
        
        return {
          score: Math.max(1, Math.min(10, score)),
          hrvDelta,
          rhrDelta,
          todayHRV,
          todayRHR,
          avgHRV: avgHRV.toFixed(0),
          avgRHR: avgRHR.toFixed(0),
          atl
        };
      };

      const getRecommendation = (recovery) => {
        if (!recovery) return { status: 'UNKNOWN', text: 'Keine Daten', color: 'gray', detail: '' };
        
        const { score, hrvDelta } = recovery;
        
        if (score >= 8) {
          return {
            status: 'GO',
            text: 'Bereit f√ºr Training',
            color: 'green',
            detail: 'HRV und Ruhepuls sind gut. Training wie geplant m√∂glich.'
          };
        } else if (score >= 6) {
          return {
            status: 'MODIFY',
            text: 'Training anpassen',
            color: 'yellow',
            detail: hrvDelta < -5 
              ? 'HRV gesunken. Intensit√§t reduzieren (Z4‚ÜíZ3).' 
              : 'Moderate Erholung. Harte Intervalle vermeiden.'
          };
        } else {
          return {
            status: 'RECOVERY',
            text: 'Nur Z1/Z2 empfohlen',
            color: 'orange',
            detail: 'K√∂rper zeigt Erm√ºdung. Heute nur locker oder Ruhetag.'
          };
        }
      };

      // Chat Handler - DEAKTIVIERT wegen CORS
      const handleChat = async () => {
        setChatMessages(prev => [...prev, { 
          role: 'assistant', 
          content: '‚ö†Ô∏è Chat-Funktion ben√∂tigt einen Backend-Proxy.\n\nDie Anthropic API kann nicht direkt vom Browser aufgerufen werden (CORS-Policy).\n\nL√∂sung: Erweitere deinen Cloudflare Worker um eine /chat Route, die Anfragen an die Anthropic API weiterleitet.' 
        }]);
      };

      const recovery = calculateRecoveryScore();
      const recommendation = getRecommendation(recovery);

      if (!isConnected) {
        return React.createElement('div', {
          className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4'
        },
          React.createElement('div', {
            className: 'bg-slate-800 rounded-xl shadow-2xl p-8 max-w-md w-full border border-slate-700'
          },
            React.createElement('div', { className: 'text-center mb-6' },
              React.createElement(Activity, { className: 'w-16 h-16 text-blue-400 mx-auto mb-4' }),
              React.createElement('h1', { className: 'text-3xl font-bold text-white mb-2' }, 'Training Agent'),
              React.createElement('p', { className: 'text-slate-400' }, 'Ultra Endurance Coach')
            ),
            React.createElement('div', { className: 'space-y-4' },
              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Athlete ID'),
                React.createElement('input', {
                  type: 'text',
                  value: athleteId,
                  onChange: (e) => setAthleteId(e.target.value),
                  className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none'
                })
              ),
              React.createElement('div', null,
                React.createElement('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'API Key'),
                React.createElement('input', {
                  type: 'password',
                  value: apiKey,
                  onChange: (e) => setApiKey(e.target.value),
                  className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none'
                })
              ),
              error && React.createElement('div', {
                className: 'bg-red-900/30 border border-red-700 text-red-300 px-4 py-3 rounded-lg text-sm'
              }, error),
              React.createElement('button', {
                onClick: connectToAPI,
                disabled: loading,
                className: 'w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors disabled:opacity-50'
              }, loading ? 'Verbinde...' : 'Verbinden')
            )
          )
        );
      }

      // Main Dashboard
      return React.createElement('div', {
        className: 'min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white'
      },
        // Header
        React.createElement('div', {
          className: 'bg-slate-800/50 border-b border-slate-700 backdrop-blur-sm sticky top-0 z-10'
        },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-4' },
            React.createElement('div', { className: 'flex items-center justify-between' },
              React.createElement('div', { className: 'flex items-center space-x-3' },
                React.createElement(Activity, { className: 'w-8 h-8 text-blue-400' }),
                React.createElement('div', null,
                  React.createElement('h1', { className: 'text-xl font-bold' }, 'Training Agent'),
                  React.createElement('p', { className: 'text-xs text-slate-400' }, 
                    `Guten Morgen, ${athleteData?.firstname || 'Athlet'}!`
                  )
                )
              ),
              React.createElement('div', { className: 'flex items-center space-x-2' },
                React.createElement('button', {
                  onClick: connectToAPI,
                  disabled: loading,
                  className: 'p-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors',
                  title: 'Aktualisieren'
                },
                  React.createElement(RefreshCw, { className: `w-5 h-5 ${loading ? 'animate-spin' : ''}` })
                )
              )
            )
          )
        ),

        // Content
        React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
          
          React.createElement('div', { className: 'space-y-6' },
            
            // Event Countdown (n√§chste 3 Events)
            upcomingEvents.length > 0 && React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700' },
              React.createElement('h2', { className: 'text-xl font-bold mb-4' }, 'üéØ Kommende Events'),
              React.createElement('div', { className: 'space-y-4' },
                upcomingEvents.slice(0, 3).map((event, idx) => {
                  const eventDate = new Date(event.start_date_local);
                  const today = new Date();
                  const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                  
                  // Bereitschaft berechnen (CTL basiert)
                  const targetCTL = event.category === 'A' ? 100 : event.category === 'B' ? 80 : 60;
                  const currentCTL = todayWellness?.ctl || 0;
                  const readiness = Math.min(100, Math.round((currentCTL / targetCTL) * 100));
                  
                  return React.createElement('div', { 
                    key: event.id || idx,
                    className: 'flex items-center justify-between bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/50 transition-colors'
                  },
                    React.createElement('div', { className: 'flex-1' },
                      React.createElement('div', { className: 'flex items-center space-x-3 mb-2' },
                        React.createElement('div', { className: 'text-lg font-bold' }, event.name),
                        React.createElement('div', { 
                          className: `px-3 py-1 rounded-lg font-bold text-xs ${
                            event.category === 'A' ? 'bg-red-600' : 
                            event.category === 'B' ? 'bg-orange-600' : 'bg-blue-600'
                          }`
                        }, `${event.category || 'C'}-Event`)
                      ),
                      React.createElement('div', { className: 'text-sm text-slate-400 mb-3' }, 
                        `${daysUntil} Tage (${eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })})`
                      ),
                      React.createElement('div', { className: 'flex items-center space-x-4' },
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-xs text-slate-400' }, 'Bereitschaft'),
                          React.createElement('div', { 
                            className: `text-lg font-bold ${readiness >= 80 ? 'text-green-400' : readiness >= 60 ? 'text-yellow-400' : 'text-orange-400'}`
                          }, `${readiness}%`)
                        ),
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-xs text-slate-400' }, 'CTL-Ziel'),
                          React.createElement('div', { className: 'text-lg font-bold' }, targetCTL)
                        ),
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-xs text-slate-400' }, 'CTL aktuell'),
                          React.createElement('div', { className: 'text-lg font-bold' }, currentCTL.toFixed(1))
                        )
                      )
                    )
                  );
                })
              )
            ),
            
            // Check-in Box
            React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700' },
              React.createElement('h2', { className: 'text-xl font-bold mb-4' }, 'T√§glicher Check-in'),
              !checkedIn ? React.createElement('div', { className: 'space-y-4' },
                React.createElement('div', null,
                  React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Wie f√ºhlst du dich heute?'),
                  React.createElement('select', {
                    value: feeling,
                    onChange: (e) => setFeeling(e.target.value),
                    className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600'
                  },
                    React.createElement('option', { value: '' }, 'Ausw√§hlen...'),
                    React.createElement('option', { value: 'frisch' }, 'üòä Frisch und erholt'),
                    React.createElement('option', { value: 'normal' }, 'üòê Normal'),
                    React.createElement('option', { value: 'muede' }, 'üò¥ Etwas m√ºde'),
                    React.createElement('option', { value: 'erschoepft' }, 'üòµ Ersch√∂pft')
                  )
                ),
                React.createElement('div', null,
                  React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Notizen (optional)'),
                  React.createElement('textarea', {
                    value: notes,
                    onChange: (e) => setNotes(e.target.value),
                    placeholder: 'Wie hast du geschlafen? Stress? Muskelkater?',
                    className: 'w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 h-24 resize-none',
                    maxLength: 500
                  })
                ),
                React.createElement('button', {
                  onClick: handleCheckIn,
                  disabled: !feeling,
                  className: 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg disabled:opacity-50'
                }, 'Check-in speichern')
              ) : React.createElement('div', { className: 'bg-green-900/20 border border-green-700 rounded-lg p-4' },
                React.createElement('div', { className: 'flex items-center mb-2' },
                  React.createElement('span', { className: 'text-2xl mr-2' }, 
                    feeling === 'frisch' ? 'üòä' : feeling === 'normal' ? 'üòê' : feeling === 'muede' ? 'üò¥' : 'üòµ'
                  ),
                  React.createElement('span', { className: 'font-semibold' }, 'Check-in abgeschlossen')
                ),
                notes && React.createElement('div', { className: 'text-sm text-slate-300 mt-2' }, notes)
              )
            ),

            // Recovery Dashboard
            React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700' },
              React.createElement('h2', { className: 'text-2xl font-bold mb-6 flex items-center' },
                React.createElement(Heart, { className: 'w-7 h-7 mr-2 text-red-400' }),
                'Recovery Status'
              ),
              
              recovery ? React.createElement('div', null,
                React.createElement('div', { className: 'flex items-center justify-between mb-6 pb-6 border-b border-slate-700' },
                  React.createElement('div', null,
                    React.createElement('div', { className: 'text-5xl font-bold mb-1' }, 
                      recovery.score.toFixed(1),
                      React.createElement('span', { className: 'text-2xl text-slate-400 ml-2' }, '/10')
                    ),
                    React.createElement('div', { className: 'text-sm text-slate-400' }, 'Recovery Score')
                  ),
                  React.createElement('div', { 
                    className: `px-8 py-4 rounded-xl font-bold text-xl ${
                      recommendation.color === 'green' ? 'bg-green-600' :
                      recommendation.color === 'yellow' ? 'bg-yellow-600' : 'bg-orange-600'
                    }`
                  }, recommendation.status)
                ),
                
                React.createElement('div', { className: 'bg-slate-700/50 rounded-lg p-5 mb-6' },
                  React.createElement('div', { className: 'font-semibold text-lg mb-2' }, recommendation.text),
                  React.createElement('div', { className: 'text-slate-300' }, recommendation.detail)
                ),
                
                React.createElement('div', { className: 'grid grid-cols-4 gap-4' },
                  React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                    React.createElement('div', { className: 'flex items-baseline' },
                      React.createElement('div', { className: 'text-3xl font-bold mr-2' }, recovery.todayHRV || 'N/A'),
                      React.createElement('div', { className: 'text-sm text-slate-400' }, 'ms')
                    ),
                    React.createElement('div', { className: 'text-xs text-slate-400 mt-1' }, `HRV (√ò7d: ${recovery.avgHRV}ms)`),
                    React.createElement('div', { 
                      className: `text-sm font-semibold mt-2 ${recovery.hrvDelta > 0 ? 'text-green-400' : 'text-red-400'}`
                    }, `${recovery.hrvDelta > 0 ? '+' : ''}${recovery.hrvDelta.toFixed(1)}%`)
                  ),
                  React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                    React.createElement('div', { className: 'flex items-baseline' },
                      React.createElement('div', { className: 'text-3xl font-bold mr-2' }, recovery.todayRHR || 'N/A'),
                      React.createElement('div', { className: 'text-sm text-slate-400' }, 'bpm')
                    ),
                    React.createElement('div', { className: 'text-xs text-slate-400 mt-1' }, `Ruhepuls (√ò7d: ${recovery.avgRHR}bpm)`),
                    React.createElement('div', { 
                      className: `text-sm font-semibold mt-2 ${recovery.rhrDelta < 0 ? 'text-green-400' : 'text-red-400'}`
                    }, `${recovery.rhrDelta > 0 ? '+' : ''}${recovery.rhrDelta.toFixed(1)}%`)
                  ),
                  React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                    React.createElement('div', { className: 'flex items-baseline' },
                      React.createElement('div', { className: 'text-3xl font-bold mr-2' }, 
                        (() => {
                          const currentWeight = todayWellness?.weight || athleteData?.icu_weight;
                          return currentWeight ? currentWeight.toFixed(1) : 'N/A';
                        })()
                      ),
                      React.createElement('div', { className: 'text-sm text-slate-400' }, 'kg')
                    ),
                    React.createElement('div', { className: 'text-xs text-slate-400 mt-1' }, 'Gewicht (Ziel: 83kg)'),
                    React.createElement('div', { 
                      className: 'text-sm font-semibold mt-2',
                      style: { color: '#94a3b8' }
                    }, 
                      (() => {
                        const currentWeight = todayWellness?.weight || athleteData?.icu_weight;
                        if (!currentWeight || !wellnessData.length) return '';
                        
                        // Berechne 7-Tage-Durchschnitt
                        const recentWeights = wellnessData.filter(d => d.weight).slice(0, 7);
                        if (recentWeights.length < 2) return '';
                        
                        const avgWeight = recentWeights.reduce((sum, d) => sum + d.weight, 0) / recentWeights.length;
                        const delta = currentWeight - avgWeight;
                        
                        return `${delta > 0 ? '+' : ''}${delta.toFixed(1)}kg vs 7d`;
                      })()
                    )
                  ),
                  React.createElement('div', { className: 'bg-slate-700/30 rounded-lg p-4' },
                    React.createElement('div', { className: 'text-3xl font-bold' }, recovery.atl ? recovery.atl.toFixed(0) : 'N/A'),
                    React.createElement('div', { className: 'text-xs text-slate-400 mt-1' }, 'ATL (Erm√ºdung)'),
                    React.createElement('div', { className: 'text-sm text-slate-300 mt-2' }, 
                      recovery.atl > 120 ? 'Erh√∂ht' : recovery.atl > 80 ? 'Normal' : 'Niedrig'
                    )
                  )
                )
              ) : React.createElement('div', { className: 'text-center py-12' },
                React.createElement(AlertCircle, { className: 'w-12 h-12 text-slate-500 mx-auto mb-3' }),
                React.createElement('div', { className: 'text-slate-400' }, 'Keine Wellness-Daten')
              )
            ),

            // Letzte Trainings
            React.createElement('div', { className: 'bg-slate-800 rounded-xl p-6 border border-slate-700' },
              React.createElement('h2', { className: 'text-2xl font-bold mb-4 flex items-center' },
                React.createElement(Calendar, { className: 'w-6 h-6 mr-2 text-purple-400' }),
                'Letzte Trainings'
              ),
              
              recentActivities.length > 0 ? React.createElement('div', { className: 'space-y-2' },
                recentActivities.slice(0, 10).map((activity, idx) => {
                  // Korrekte Feldnamen basierend auf API-Struktur
                  const hr = activity.average_heartrate || null;
                  const watts = activity.icu_weighted_avg_watts || activity.icu_average_watts || null;
                  
                  // Zonen-Zeiten holen (in Sekunden)
                  const zoneTimes = activity.icu_zone_times || [];
                  
                  // Debug: Log f√ºr erstes Training
                  if (idx === 0) {
                    console.log('Activity Zonen-Debug:', {
                      name: activity.name,
                      has_icu_zone_times: !!activity.icu_zone_times,
                      zone_times: activity.icu_zone_times,
                      all_keys: Object.keys(activity).filter(k => k.includes('zone'))
                    });
                  }
                  
                  // Top 3 Zonen mit meister Zeit finden
                  const zonesWithTime = zoneTimes
                    .map((seconds, zoneIdx) => ({ zone: zoneIdx + 1, seconds }))
                    .filter(z => z.seconds > 0)
                    .sort((a, b) => b.seconds - a.seconds)
                    .slice(0, 3);
                  
                  const totalTime = zoneTimes.reduce((sum, t) => sum + t, 0);
                  
                  return React.createElement('div', { 
                    key: idx,
                    className: 'bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/50 transition-colors'
                  },
                    React.createElement('div', { className: 'flex items-center justify-between mb-3' },
                      React.createElement('div', { className: 'flex-1' },
                        React.createElement('div', { className: 'font-medium' }, activity.name || 'Training'),
                        React.createElement('div', { className: 'text-sm text-slate-400 mt-1' },
                          new Date(activity.start_date_local).toLocaleDateString('de-DE', { 
                            weekday: 'short', 
                            day: '2-digit', 
                            month: '2-digit' 
                          })
                        )
                      ),
                      React.createElement('div', { className: 'grid grid-cols-4 gap-4 text-right' },
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-lg font-bold' }, activity.icu_training_load?.toFixed(0) || 'N/A'),
                          React.createElement('div', { className: 'text-xs text-slate-400' }, 'TSS')
                        ),
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-lg font-bold' }, (activity.moving_time / 3600).toFixed(1)),
                          React.createElement('div', { className: 'text-xs text-slate-400' }, 'Stunden')
                        ),
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-lg font-bold' }, hr ? Math.round(hr) : 'N/A'),
                          React.createElement('div', { className: 'text-xs text-slate-400' }, '√ò HR')
                        ),
                        React.createElement('div', null,
                          React.createElement('div', { className: 'text-lg font-bold' }, watts ? Math.round(watts) : 'N/A'),
                          React.createElement('div', { className: 'text-xs text-slate-400' }, '√ò Watt')
                        )
                      )
                    ),
                    
                    // Zonen-Anzeige
                    zonesWithTime.length > 0 && React.createElement('div', { className: 'space-y-1 pt-2 border-t border-slate-600' },
                      zonesWithTime.map((zoneData, zIdx) => {
                        const minutes = Math.round(zoneData.seconds / 60);
                        const percentage = totalTime > 0 ? (zoneData.seconds / totalTime * 100) : 0;
                        
                        // Farben f√ºr Zonen
                        const zoneColors = {
                          1: 'bg-gray-500',
                          2: 'bg-blue-500',
                          3: 'bg-green-500',
                          4: 'bg-yellow-500',
                          5: 'bg-orange-500',
                          6: 'bg-red-500',
                          7: 'bg-purple-500'
                        };
                        
                        return React.createElement('div', { key: zIdx, className: 'flex items-center space-x-2' },
                          React.createElement('div', { className: 'text-xs text-slate-400 w-8' }, `Z${zoneData.zone}`),
                          React.createElement('div', { className: 'flex-1 bg-slate-800 rounded-full h-2 overflow-hidden' },
                            React.createElement('div', { 
                              className: zoneColors[zoneData.zone] || 'bg-slate-500',
                              style: { width: `${percentage}%` }
                            })
                          ),
                          React.createElement('div', { className: 'text-xs text-slate-300 w-16 text-right' }, `${minutes}min`)
                        );
                      })
                    )
                  );
                })
              ) : React.createElement('div', { className: 'text-slate-400 text-center py-8' }, 'Keine Aktivit√§ten')
            )
          )
        )
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(TrainingAgent));
  </script>
</body>
</html>
